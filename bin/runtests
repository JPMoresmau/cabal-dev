#!/usr/bin/env bash
set -e
set -x

PATH="${HOME}/haskell/runtime/haskell-platform-2009.2.0.2/bin:${PATH}"
SANDBOX=cabal-dev

# Bootstrap package db. cabal-dev can do this, but we want to build
# cabal-dev itself in a sandbox
function init-pkg-db {
    VER_STR="$(ghc-pkg --version)"
    case "$VER_STR" in
        "GHC package manager version 6.10."*)
            PKGDB=${SANDBOX}/packages.conf
            [ -f "${PKGDB}" ] || echo -n "[]" > "${PKGDB}"
            ;;
        "GHC package manager version 6.12."*)
            PKGDB=${SANDBOX}/packages.conf.d
            [ -d "${PKGDB}" ] || ghc-pkg init "${PKGDB}"
            ;;
        *)
            echo "This script can handle ghc-pkg 6.10 and " \
                "6.12, but cannot handle other versions" 1>&2
            exit 1
            ;;
    esac
}

rewriteCabalConfig () {
    CFGIN="$1"
    CFGOUT="$2"
    HERE=$(pwd)
    OUT="${CFGOUT}.tmp"
    TILDE=$(echo "$HOME" | sed 's/\//\\\//g')
    DOT=$(pwd | sed 's/\//\\\//g')
    PKG=$(basename "${PKGDB}" | sed 's/\//\\\//g')
    sed -e 's/ ~\//'"$TILDE"'\//g' \
        -e 's/ \.\// '"$DOT"'\//g' "$CFGIN" \
        -e 's/\/packages.conf$/\/'"${PKG}"'/g' > "${OUT}"
    mv "${OUT}" "${CFGOUT}"
}

mkdir -p $SANDBOX
init-pkg-db
rewriteCabalConfig admin/cabal-config.in "${SANDBOX}/cabal.config"
cabal --config-file="${SANDBOX}/cabal.config" install
"${SANDBOX}/bin/cabal-dev" add-source .
